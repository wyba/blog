<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>BLE开发 | wyb&#39;s blog</title>
    <meta name="generator" content="VuePress 1.8.0">
    <link rel="icon" href="/blog/img/favicon.ico">
    <script data-ad-client="ca-pub-7828333725993554" async="async" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <meta name="description" content="主流技术博客,简洁至上,专注全栈学习与总结。">
    <meta name="keywords" content="前端博客,个人技术博客,前端,前端开发,前端框架,web前端,前端面试题,技术文档,学习,面试,JavaScript,js,ES6,TypeScript,vue,python,css3,html5,Node,git,github,markdown">
    <meta name="baidu-site-verification" content="7F55weZDDc">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/blog/assets/css/0.styles.7dd69afa.css" as="style"><link rel="preload" href="/blog/assets/js/app.7a0bcda5.js" as="script"><link rel="preload" href="/blog/assets/js/2.a5a0f980.js" as="script"><link rel="preload" href="/blog/assets/js/37.9036f6e9.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.2ffa04b0.js"><link rel="prefetch" href="/blog/assets/js/11.70f92a32.js"><link rel="prefetch" href="/blog/assets/js/12.340f549c.js"><link rel="prefetch" href="/blog/assets/js/13.9e5f7372.js"><link rel="prefetch" href="/blog/assets/js/14.b9340184.js"><link rel="prefetch" href="/blog/assets/js/15.6c1f35df.js"><link rel="prefetch" href="/blog/assets/js/16.e3c6e4ef.js"><link rel="prefetch" href="/blog/assets/js/17.0053c99b.js"><link rel="prefetch" href="/blog/assets/js/18.45a0f3ed.js"><link rel="prefetch" href="/blog/assets/js/19.fb9cc485.js"><link rel="prefetch" href="/blog/assets/js/20.3d5c7a50.js"><link rel="prefetch" href="/blog/assets/js/21.3d0ee275.js"><link rel="prefetch" href="/blog/assets/js/22.e8a9df9a.js"><link rel="prefetch" href="/blog/assets/js/23.82ed3e72.js"><link rel="prefetch" href="/blog/assets/js/24.9d7a7b68.js"><link rel="prefetch" href="/blog/assets/js/25.0bc9ab07.js"><link rel="prefetch" href="/blog/assets/js/26.d2b7a967.js"><link rel="prefetch" href="/blog/assets/js/27.2c02fa2c.js"><link rel="prefetch" href="/blog/assets/js/28.a1afa2d7.js"><link rel="prefetch" href="/blog/assets/js/29.10d9dc2f.js"><link rel="prefetch" href="/blog/assets/js/3.8ec5b007.js"><link rel="prefetch" href="/blog/assets/js/30.425d8100.js"><link rel="prefetch" href="/blog/assets/js/31.63e4f8fb.js"><link rel="prefetch" href="/blog/assets/js/32.77a66ca1.js"><link rel="prefetch" href="/blog/assets/js/33.d0e23080.js"><link rel="prefetch" href="/blog/assets/js/34.1e204563.js"><link rel="prefetch" href="/blog/assets/js/35.2833874a.js"><link rel="prefetch" href="/blog/assets/js/36.97de71b1.js"><link rel="prefetch" href="/blog/assets/js/38.6793c03d.js"><link rel="prefetch" href="/blog/assets/js/39.849e03fc.js"><link rel="prefetch" href="/blog/assets/js/4.6e55e017.js"><link rel="prefetch" href="/blog/assets/js/40.56980ac8.js"><link rel="prefetch" href="/blog/assets/js/41.7a196738.js"><link rel="prefetch" href="/blog/assets/js/42.10732ea3.js"><link rel="prefetch" href="/blog/assets/js/43.810ba5a4.js"><link rel="prefetch" href="/blog/assets/js/44.73bbd126.js"><link rel="prefetch" href="/blog/assets/js/45.63b7b5a1.js"><link rel="prefetch" href="/blog/assets/js/46.a65e64ce.js"><link rel="prefetch" href="/blog/assets/js/47.00dc050a.js"><link rel="prefetch" href="/blog/assets/js/48.b91a0ddd.js"><link rel="prefetch" href="/blog/assets/js/49.4a16d835.js"><link rel="prefetch" href="/blog/assets/js/5.4843dc8e.js"><link rel="prefetch" href="/blog/assets/js/50.132e204b.js"><link rel="prefetch" href="/blog/assets/js/51.1345b9a1.js"><link rel="prefetch" href="/blog/assets/js/52.742ee8db.js"><link rel="prefetch" href="/blog/assets/js/53.8d9c7dd6.js"><link rel="prefetch" href="/blog/assets/js/54.c4038d3f.js"><link rel="prefetch" href="/blog/assets/js/55.766e53e6.js"><link rel="prefetch" href="/blog/assets/js/56.ad60a3d1.js"><link rel="prefetch" href="/blog/assets/js/57.13758d00.js"><link rel="prefetch" href="/blog/assets/js/58.ee3f65e8.js"><link rel="prefetch" href="/blog/assets/js/59.602af4ee.js"><link rel="prefetch" href="/blog/assets/js/6.da76d55e.js"><link rel="prefetch" href="/blog/assets/js/60.15e31058.js"><link rel="prefetch" href="/blog/assets/js/61.7f219b23.js"><link rel="prefetch" href="/blog/assets/js/62.10d98d67.js"><link rel="prefetch" href="/blog/assets/js/63.8ef0d49d.js"><link rel="prefetch" href="/blog/assets/js/64.983ab7ac.js"><link rel="prefetch" href="/blog/assets/js/65.37330ddf.js"><link rel="prefetch" href="/blog/assets/js/66.2776a634.js"><link rel="prefetch" href="/blog/assets/js/67.8b5b3535.js"><link rel="prefetch" href="/blog/assets/js/68.cccc4d3a.js"><link rel="prefetch" href="/blog/assets/js/7.ba6e6c9a.js"><link rel="prefetch" href="/blog/assets/js/8.99b38245.js"><link rel="prefetch" href="/blog/assets/js/9.fc8f51e1.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.7dd69afa.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><img src="/blog/img/EB-logo.png" alt="wyb's blog" class="logo"> <span class="site-name can-hide">wyb's blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link">首页</a></div><div class="nav-item"><a href="/blog/pages/beb6c0bd8a66cea6/" class="nav-link">收藏</a></div> <a href="https://github.com/wyba/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="https://cdn.jsdelivr.net/gh/wyba/image_store/blog/lufei.jpeg"> <div class="blogger-info"><h3>wyb</h3> <span>吾日三省吾身</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link">首页</a></div><div class="nav-item"><a href="/blog/pages/beb6c0bd8a66cea6/" class="nav-link">收藏</a></div> <a href="https://github.com/wyba/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/blog/pages/android_1/" class="sidebar-link">科大讯飞SDK使用总结</a></li><li><a href="/blog/pages/android_2/" class="sidebar-link">PDA串口UnsatisfiedLinkError解决</a></li><li><a href="/blog/pages/android_3/" class="sidebar-link">科大讯飞声纹识别WebApi鉴权认证失败解决</a></li><li><a href="/blog/pages/android_4/" class="sidebar-link">Android获取以太网mac、ip、网关、子网掩码</a></li><li><a href="/blog/pages/android_5/" class="sidebar-link">Android科大讯飞离线命令词+声纹识别终极奥义</a></li><li><a href="/blog/pages/android_6/" class="sidebar-link">Android物联网三年开发总结</a></li><li><a href="/blog/pages/android_7/" class="sidebar-link">BaseFragment封装</a></li><li><a href="/blog/pages/android_8/" class="sidebar-link">File封装</a></li><li><a href="/blog/pages/android_9/" class="sidebar-link">AndroidX项目迁移</a></li><li><a href="/blog/pages/android_10/" class="sidebar-link">视频通话测试踩坑</a></li><li><a href="/blog/pages/a9e14e/" class="sidebar-link">Android Jetpack简介</a></li><li><a href="/blog/pages/2ebf62/" class="sidebar-link">Android Jetpack+MVVM</a></li><li><a href="/blog/pages/874c9e/" class="sidebar-link">Androidx分包</a></li><li><a href="/blog/pages/066351/" class="sidebar-link">Android性能优化</a></li><li><a href="/blog/pages/bac66b/" class="sidebar-link">Android Activity</a></li><li><a href="/blog/pages/08ee91/" class="sidebar-link">Android BroadcastReceiver</a></li><li><a href="/blog/pages/6f10c5/" class="sidebar-link">Android Service</a></li><li><a href="/blog/pages/7284b2/" class="sidebar-link">Android ContentProvider</a></li><li><a href="/blog/pages/14545c/" class="sidebar-link">Android Fragment</a></li><li><a href="/blog/pages/004b87/" class="sidebar-link">Android序列化</a></li><li><a href="/blog/pages/7b3423/" class="sidebar-link">View事件机制</a></li><li><a href="/blog/pages/420b54/" class="sidebar-link">多进程及IPC</a></li><li><a href="/blog/pages/e86925/" class="sidebar-link">Bitmap加载优化</a></li><li><a href="/blog/pages/b906ee/" class="sidebar-link">ListView原理及复用机制</a></li><li><a href="/blog/pages/19c834/" class="sidebar-link">OkHttp原理</a></li><li><a href="/blog/pages/e5b1b5/" class="sidebar-link">EventBus原理</a></li><li><a href="/blog/pages/37f9d7/" class="sidebar-link">MeasureSpec原理</a></li><li><a href="/blog/pages/99060e/" class="sidebar-link">View工作流程</a></li><li><a href="/blog/pages/8aff38/" class="sidebar-link">动画简介</a></li><li><a href="/blog/pages/af8584/" aria-current="page" class="active sidebar-link">BLE开发</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/blog/pages/af8584/#介绍" class="sidebar-link">介绍</a></li><li class="sidebar-sub-header level2"><a href="/blog/pages/af8584/#连接模式" class="sidebar-link">连接模式</a></li><li class="sidebar-sub-header level2"><a href="/blog/pages/af8584/#gatt协议" class="sidebar-link">GATT协议</a></li><li class="sidebar-sub-header level2"><a href="/blog/pages/af8584/#使用过程" class="sidebar-link">使用过程</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/blog/pages/af8584/#扫描" class="sidebar-link">扫描</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/blog/pages/af8584/#连接" class="sidebar-link">连接</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/blog/pages/af8584/#设备连接" class="sidebar-link">设备连接</a></li><li class="sidebar-sub-header level3"><a href="/blog/pages/af8584/#发现服务" class="sidebar-link">发现服务</a></li><li class="sidebar-sub-header level3"><a href="/blog/pages/af8584/#数据传输" class="sidebar-link">数据传输</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/blog/pages/af8584/#其他" class="sidebar-link">其他</a></li><li class="sidebar-sub-header level2"><a href="/blog/pages/af8584/#断开连接" class="sidebar-link">断开连接</a></li><li class="sidebar-sub-header level2"><a href="/blog/pages/af8584/#分包与组包" class="sidebar-link">分包与组包</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/blog/pages/af8584/#分包" class="sidebar-link">分包：</a></li><li class="sidebar-sub-header level3"><a href="/blog/pages/af8584/#组包" class="sidebar-link">组包：</a></li></ul></li></ul></li></ul> <div class="sidebar-slot sidebar-slot-bottom"><!-- 正方形 -->
      <ins class="adsbygoogle"
          style="display:block"
          data-ad-client="ca-pub-7828333725993554"
          data-ad-slot="3508773082"
          data-ad-format="auto"
          data-full-width-responsive="true"></ins>
      <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
      </script></div></aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-1baff76c><div class="articleInfo" data-v-1baff76c><ul class="breadcrumbs" data-v-1baff76c><li data-v-1baff76c><a href="/blog/" title="首页" class="iconfont icon-home router-link-active" data-v-1baff76c></a></li> <li data-v-1baff76c><a href="/blog/Android/#Android" data-v-1baff76c>Android</a></li></ul> <div class="info" data-v-1baff76c><div title="作者" class="author iconfont icon-touxiang" data-v-1baff76c><a href="https://github.com/wyba" target="_blank" title="作者" class="beLink" data-v-1baff76c>wyb</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-1baff76c><a href="javascript:;" data-v-1baff76c>2022-04-29</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABGpJREFUSA3tVVtoXFUU3fvOI53UlmCaKIFmwEhsE7QK0ipFEdHEKpXaZGrp15SINsXUWvBDpBgQRKi0+KKoFeJHfZA+ED9KKoIU2gYD9UejTW4rVIzm0VSTziPzuNu1z507dibTTjL4U/DAzLn3nL3X2o91ziX6f9wMFdh6Jvbm9nNSV0msViVO6tN1Rm7NMu2OpeJ9lWBUTDxrJbYTS0hInuwciu9eLHlFxCLCZEk3MegsJmZ5K/JD6t7FkFdEvGUo1g7qJoG3MHImqRIn8/nzY1K9UPKKiJmtnUqHVE3Gbuay6vJE/N2FEmuxFjW2nUuE0yQXRRxLiTUAzs36zhZvOXJPdX850EVnnLZkB8prodQoM5JGj7Xk2mvC7JB8tG04Ef5PiXtG0UtxupRQSfTnBoCy554x18yJHI6I+G5Eru4LHmPJZEQsrvPUbMiA8G/WgMK7w7I+ez7++o2ANfbrjvaOl1tFMs+htG3IrZH9/hDX1Pr8Tc0UvH8tcX29KzAgIGcEkINyW5BF9x891hw6VYqgJHEk0huccS7vh3C6gTiODL+26huuBtbct8eZnqLML8PkxGYpuPZBqtqwkSjgc4mB5gbgig5i+y0UDK35LMxXisn9xQtK+nd26gTIHsHe/oblK/b29fUmN/8Y+9jAQrnBp56m1LcDlDp9irKTExSKduXJVWSqdBMA08pEJnEIOB3FPPMybu/oeV8zFeYN3xx576Q6RH+VmplE4ncQV5v+5rzSoyOU7PuEAg8g803PwBJ0CExno/jcMbN8tONYeOmHiuUNryvm3fRUy4tMPVLdAGkUhNWuggGrJcXPv+ouCjz0MKUHz1J2/E8IC9nqTabcxgaBYM0hPhD5Y65FsbxRQKxCQrDjDctW7PUM3HuZunFyifSAqEfuzCp48Il24luWUWZoyJCaPR82jE0+kFA643wRFVni4RYSq3ohJO2pZ7B5dO4xkDWbEpossJPLSrPjYID8rS2UHTlvyNxqIGsg674XJJ7vnh5L7PNwC4hh2sjCI96mzszOTpxLF0T7l88Yz7lAuK6OnL8gXLOnTvpzSb22YG8W7us3jSebFHeeqnXRG1vt+MoUM84LQIBmMsCTAcOauTh0T0l0neQK7m2bLMt2mGxU3HYssS0J2cdv5wljlPsrIuZLAG/2DOZIXgCYT8uMGZN+e2kSirfxZOPCsC0f24nTZzspnVn9VePS1Z5vubmAGGXG8ZFno9Hel0yfA5ZPhF7Dh972BQJ2qCpgH67lmWtBYbvk6sz02wjky2vXyz0XErP/kFB619js1BtwfOV4OPRqOQBjy3Qbk18vigUPPSD5ceHnwck7W9bhAqZdd7SuG7w4/P2F/GaJh8c7e9qgow+Q7cGBo+98WsLkuktFqiZabtXuQTu/Y5ETbR0v7tNSFnvrmu6pjdoan2KjMu8q/Hmj1EfCO2ZGfEIbIXKUlw8qaX9/b2oeSJmFksSeT/Fn0V3nSypChh4Gjh74ybO9aeZ/AN2dwciu2/MhAAAAAElFTkSuQmCC">BLE开发<!----></h1> <div class="page-slot page-slot-top"><!-- 固定100% * 90px可显示，max-height:90px未见显示-->
     <ins class="adsbygoogle"
          style="display:inline-block;width:100%;max-height:90px"
          data-ad-client="ca-pub-7828333725993554"
          data-ad-slot="6625304284"></ins>
      <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
      </script></div> <div class="theme-vdoing-content content__default"><blockquote><p>醉了</p></blockquote> <h2 id="介绍"><a href="#介绍" class="header-anchor">#</a> 介绍</h2> <p>BLE 是 Bluetooth Low Energy 的缩写，意思为低功耗蓝牙。由蓝牙技术联盟（Bluetooth  SIG）设计的无线通讯技术，主要用于医疗，健身，安全和家庭娱乐行业。  与传统蓝牙相比，蓝牙低功耗旨在大幅降低功耗和成本，同时也能够达到相同的通讯效果。</p> <p>在 Android 4.3 (API level 18) 以后引进来的，通过这些 API 可以扫描蓝牙设备、连接设备，查询 services、读写设备的 characteristics（属性特征），然后通过属性进行数据传输。</p> <p>特点：</p> <p>低功耗，使用 BLE 与周围设备进行通讯时，其峰值功耗为传统蓝牙的一半</p> <p>传输距离提升到 100 米</p> <p>低延时，最短可在3 ms内完成连接并开始进行数据传输</p> <p>缺点：</p> <p>传输数据量较小，最大 512 个字节，超过 20 个字节需要分包处理</p> <p>应用领域：</p> <p>主要用于智能硬件，像健康护理、运动和健身、设备电源管理等</p> <p>Android手机间通过蓝牙方式进行通信，有两种常见的方式，一种是socket方式，另一种是通过GATT Server（Android 5.0以后）通信。</p> <p>（1）socket方式最为简单，但是很多低功耗的蓝牙设备，如单片机上的蓝牙模块可能不支持</p> <p>（2）GATT方式相对比较复杂</p> <p>（3）socket、GATT均为C/S（client-server)模式</p> <h2 id="连接模式"><a href="#连接模式" class="header-anchor">#</a> 连接模式</h2> <p>对于BLE单设备来讲常见的蓝牙模块的工作模有四种：</p> <p>主设备模式</p> <p>从设备模式</p> <p>广播模式</p> <p>Mesh组网模式</p> <p><strong>主设备模式</strong></p> <p>可以与一个从设备进行连接。在此模式下可以对周围设备进行搜索并选择需要连接的从设备进行连接。同时可以设置默认连接从设备的MAC地址，这样模块上电之后就可以查找此模块并进行连接。</p> <p><strong>从设备模式</strong></p> <p>BLE支持从设备模式，在此模式下完全符合BLE4.1协议，用户可以根据协议自己开发APP。此模式下包含一个串口收发的Service，用户可以通过UUID找到它，里面有两个通道，分别是读和写。用户可以操作这两个通道进行数据的传输。</p> <p><strong>广播模式</strong></p> <p>在这种模式下模块可以一对多进行广播。用户可以通过AT指令设置模块广播的数据，模块可以在低功耗的模式下持续的进行广播，应用于极低功耗，小数据量，单向传输的应用场合，比如无线抄表，室内定位等功能。</p> <p><strong>Mesh组网模式</strong></p> <p>在这种模式下模块可以实现简单的自组网络，每个模块只需要设置相同的通讯密码就可以加入到同一网络当中，每一个模块都可以发起数据，每个模块可以收到数据并且进行回复。并且不需要网关，即使某一个设备出现故障也会跳过并选择最近的设备进行传输。</p> <h2 id="gatt协议"><a href="#gatt协议" class="header-anchor">#</a> GATT协议</h2> <p>GATT generic Attributes的缩写，中文是通用属性，是低功耗蓝牙设备之间进行通信的协议。</p> <p>GATT定义了一种多层的数据结构，已连接的低功耗蓝牙设备用它来进行通信，GATT层是传输真正数据所在的层。一个GATT服务器通过一个称为属性表的表格组织数据，这些数据就是用于真正发送的数据。</p> <p>GATT定义的多层数据结构简要概括起来就是服务（service）可以包含多个特征（characteristic），每个特征包含属性（properties）和值（value），还可以包含多个描述（descriptor）。它形象的结构如下图：</p> <p><img src="https://img.jbzj.com/file_images/article/202111/20211124101708724.png?20211024101741" alt="img"></p> <p><strong>profile（数据配置文件）</strong></p> <p>一个profile文件可以包含一个或者多个服务，一个profile文件包含需要的服务的信息或者为对等设备如何交互的配置文件的选项信息。设备的GAP和GATT的角色都可能在数据的交换过程中改变，因此，这个文件应该包含广播的种类、所使用的连接间隔、所需的安全等级等信息。</p> <p>需要注意的是： 一个profile中的属性表不能包含另一个属性表。</p> <p><strong>属性</strong></p> <p>一个属性包含句柄、UUID(类型)、值，句柄是属性在GATT表中的索引，在一个设备中每一个属性的句柄都是唯一的。UUID包含属性表中数据类型的信息，它是理解属性表中的值的每一个字节的意义的关键信息。在一个GATT表中可能有许多属性，这些属性能可能有相同的UUID。</p> <p>个人理解，属性指的是 Service、Characteristic 这样的对象</p> <p><strong>Service</strong></p> <p>一个低功耗蓝牙设备可以定义许多 Service, Service 可以理解为一个功能的集合。设备中每一个不同的 Service 都有一个  128 bit 的 UUID 作为这个 Service  的独立标志。蓝牙核心规范制定了两种不同的UUID，一种是基本的UUID，一种是代替基本UUID的16位UUID。所有的蓝牙技术联盟定义UUID共用了一个基本的UUID：</p> <p>0x0000xxxx-0000-1000-8000-00805F9B34FB</p> <p>为了进一步简化基本UUID，每一个蓝牙技术联盟定义的属性有一个唯一的16位UUID，以代替上面的基本UUID的‘x'部分。例如，心率测量特性使用0X2A37作为它的16位UUID，因此它完整的128位UUID为：</p> <p>0x00002A37-0000-1000-8000-00805F9B34FB</p> <p><strong>Characteristic</strong></p> <p>在 Service 下面，又包括了许多的独立数据项，我们把这些独立的数据项称作 Characteristic。同样的，每一个  Characteristic 也有一个唯一的 UUID 作为标识符。在 Android  开发中，建立蓝牙连接后，我们说的通过蓝牙发送数据给外围设备就是往这些 Characteristic 中的 Value  字段写入数据；外围设备发送数据给手机就是监听这些 Charateristic 中的 Value 字段有没有变化，如果发生了变化，手机的 BLE  API 就会收到一个监听的回调。</p> <p><strong>DesCriptor</strong></p> <p>任何在特性中的属性不是定义为属性值就是为描述符。描述符是一个额外的属性以提供更多特性的信息，它提供一个人类可识别的特性描述的实例。然而，有一个特别的描述符值得特别地提起：客户端特性配置描述符(Client Characteristic Configuration  Descriptor，CCCD)，这个描述符是给任何支持通知或指示功能的特性额外增加的。在CCCD中写入“1”使能通知功能，写入“2”使能指示功能，写入“0”同时禁止通知和指示功能。</p> <h2 id="使用过程"><a href="#使用过程" class="header-anchor">#</a> 使用过程</h2> <p>常采用的模式是主机模式，然后扫描客户端硬件，然后连接，获取相关服务和特性，然后进行数据传输。</p> <p><img src="https://cdn.jsdelivr.net/gh/wyba/image_store/blog/20211124101918506.jpg" alt="img"></p> <h3 id="扫描"><a href="#扫描" class="header-anchor">#</a> 扫描</h3> <p>权限获取</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>uses-permission</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>android.permission.BLUETOOTH<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span> 使用蓝牙所需要的权限
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>uses-permission</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>android.permission.BLUETOOTH_ADMIN<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span> 使用扫描和设置蓝牙的
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>在Android5.0之前，是默认申请GPS硬件功能的。而在Android 5.0 之后，需要在manifest 中申明GPS硬件模块功能的使用。</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token comment">&lt;!-- Needed only if your app targets Android 5.0 (API level 21) or higher. --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>uses-feature</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>android.hardware.location.gps<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>在 Android 6.0 及以上，还需要打开位置权限。如果应用没有位置权限，蓝牙扫描功能不能使用（其它蓝牙操作例如连接蓝牙设备和写入数据不受影响）。</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>uses-permission</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>android.permission.ACCESS_COARSE_LOCATION<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>除了上面的设置之外，如果想设置设备只支持 BLE，可以加上下面这句话</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>uses-feature</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>android.hardware.bluetooth_le<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">android:</span>required</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>true<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>同样，如果不想添加 BLE 的支持，那么可以设置 required=&quot;false&quot;</p> <p>然后可以在运行时判断设备是否支持 BLE，</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// Use this check to determine whether BLE is supported on the device. Then</span>
<span class="token comment">// you can selectively disable BLE-related features.</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">getPackageManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hasSystemFeature</span><span class="token punctuation">(</span><span class="token class-name">PackageManager</span><span class="token punctuation">.</span>FEATURE_BLUETOOTH_LE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Toast</span><span class="token punctuation">.</span><span class="token function">makeText</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token punctuation">.</span>string<span class="token punctuation">.</span>ble_not_supported<span class="token punctuation">,</span> <span class="token class-name">Toast</span><span class="token punctuation">.</span>LENGTH_SHORT<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><strong>初始化</strong></p> <p>判断 BLE 在设备上是否支持，如果不支持的话，那么可以不用继续后面的操作了；如果支持，但是有可能蓝牙被禁掉了，因为开着蓝牙比较好点，用户一般都会关闭蓝牙，这时候可以发送请求，来打开蓝牙，可以通过两个步骤来完成。</p> <p>1.获取 BluetoothAdapter</p> <p>BluetoothAdapter 对于一个设备来说唯一的，整个系统或者应用，对蓝牙进行操作时都是需要这个的适配器。它的获取需要通过系统服务来获取。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">BluetoothAdapter</span> mBluetoothAdapter<span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token comment">// Initializes Bluetooth adapter.</span>
<span class="token keyword">final</span> <span class="token class-name">BluetoothManager</span> bluetoothManager <span class="token operator">=</span>
        <span class="token punctuation">(</span><span class="token class-name">BluetoothManager</span><span class="token punctuation">)</span> <span class="token function">getSystemService</span><span class="token punctuation">(</span><span class="token class-name">Context</span><span class="token punctuation">.</span>BLUETOOTH_SERVICE<span class="token punctuation">)</span><span class="token punctuation">;</span>
mBluetoothAdapter <span class="token operator">=</span> bluetoothManager<span class="token punctuation">.</span><span class="token function">getAdapter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>2.打开蓝牙</p> <p>一般对于用户来说，在手机上蓝牙是关闭，当开启你的应用时就需要开启蓝牙，有两种方式，一种是跳转到设置界面，由用户自己开启蓝牙；</p> <p>另外一种时，直接在应用开启蓝牙，不需要用户打开，而是直接帮用户开启手机上的蓝牙。</p> <p>跳转到设置界面</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// Ensures Bluetooth is available on the device and it is enabled. If not,</span>
<span class="token comment">// displays a dialog requesting user permission to enable Bluetooth.</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>mBluetoothAdapter <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token operator">!</span>mBluetoothAdapter<span class="token punctuation">.</span><span class="token function">isEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Intent</span> enableBtIntent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span><span class="token class-name">BluetoothAdapter</span><span class="token punctuation">.</span>ACTION_REQUEST_ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">startActivityForResult</span><span class="token punctuation">(</span>enableBtIntent<span class="token punctuation">,</span> REQUEST_ENABLE_BT<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>直接开启蓝牙</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 打开蓝牙</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mBluetoothAdapter<span class="token punctuation">.</span><span class="token function">isEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    mBluetoothAdapter<span class="token punctuation">.</span><span class="token function">enable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><strong>扫描</strong></p> <p>扫描蓝牙设备可以通过startLeScan(),其中有一个参数是 ScanCallback,通过它返回扫描结果，因为扫描过程是很耗电的，所以在扫描过程需要保证</p> <p>1.一旦找到目标设备，需要停止扫描</p> <p>2.扫描不要设置循环，而且需要设置一个时间</p> <p>回调如下</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 设备扫描回调</span>
    <span class="token keyword">private</span> <span class="token class-name">ScanCallback</span> mScanCallback <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ScanCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onScanResult</span><span class="token punctuation">(</span><span class="token keyword">int</span> callbackType<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">ScanResult</span> result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 
            <span class="token function">runOnUiThread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 
                    <span class="token comment">// 广播的信息，可以在result中获取</span>
                    <span class="token class-name">MDevice</span> mDev <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MDevice</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getDevice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> result<span class="token punctuation">.</span><span class="token function">getRssi</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mList<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>mDev<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        mList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>mDev<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>mList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        mScanner<span class="token punctuation">.</span><span class="token function">stopScan</span><span class="token punctuation">(</span>mScanCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">Toast</span><span class="token punctuation">.</span><span class="token function">makeText</span><span class="token punctuation">(</span><span class="token class-name">MainActivity</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token string">&quot;扫描结束，设备数 &quot;</span> <span class="token operator">+</span> mList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                <span class="token punctuation">,</span> <span class="token class-name">Toast</span><span class="token punctuation">.</span>LENGTH_SHORT<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>开始扫描</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">BluetoothAdapter</span> mBluetoothAdapter<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> mScanning<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Handler</span> mHandler<span class="token punctuation">;</span>
 
    <span class="token comment">// Stops scanning after 10 seconds.</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> SCAN_PERIOD <span class="token operator">=</span> <span class="token number">10000</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">scanLeDevice</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">boolean</span> enable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>enable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Stops scanning after a pre-defined scan period.</span>
            mHandler<span class="token punctuation">.</span><span class="token function">postDelayed</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    mScanning <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                    mBluetoothAdapter<span class="token punctuation">.</span><span class="token function">stopLeScan</span><span class="token punctuation">(</span>mLeScanCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span> SCAN_PERIOD<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
            mScanning <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            mBluetoothAdapter<span class="token punctuation">.</span><span class="token function">startLeScan</span><span class="token punctuation">(</span>mLeScanCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            mScanning <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            mBluetoothAdapter<span class="token punctuation">.</span><span class="token function">stopLeScan</span><span class="token punctuation">(</span>mLeScanCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>这里遇到一个坑，就是实际中手机与一些智能硬件连接时，也就是需要连接指定的硬件，设备有一个UUID，所以可以通过如下方法连接</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token function">startLeScan</span><span class="token punctuation">(</span>UUID<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token class-name">BluetoothAdapter<span class="token punctuation">.</span>LeScanCallback</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>但是实际中使用时，连接时会出错，仍需要再次验证。</p> <p>我当时的做法是采用了另外一种方法,当时这种方法，要求 API 高于 21。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">scanLeDevice</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 
    <span class="token comment">//50秒后停止扫描</span>
    mHander<span class="token punctuation">.</span><span class="token function">postDelayed</span><span class="token punctuation">(</span>stopScanRunnable<span class="token punctuation">,</span> <span class="token number">50000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ScanFilter</span><span class="token punctuation">&gt;</span></span> filters <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ScanFilter</span> filter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ScanFilter<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token comment">//&quot;D8:B0:4C:E8:66:DC&quot; 测试MAC 1</span>
            <span class="token comment">//&quot;D8:B0:4C:E2:45:2A&quot;  测试MAC 2</span>
            <span class="token punctuation">.</span><span class="token function">setDeviceAddress</span><span class="token punctuation">(</span><span class="token string">&quot;D8:B0:4C:E2:45:2A&quot;</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    filters<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>filter<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
    <span class="token comment">// 扫描</span>
    mScanner<span class="token punctuation">.</span><span class="token function">startScan</span><span class="token punctuation">(</span>filters<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ScanSettings<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setScanMode</span><span class="token punctuation">(</span><span class="token class-name">ScanSettings</span><span class="token punctuation">.</span>SCAN_MODE_LOW_LATENCY<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mScanCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>扫描结束后需要停止扫描</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">boolean</span> <span class="token function">startLeScan</span><span class="token punctuation">(</span><span class="token class-name">BluetoothAdapter<span class="token punctuation">.</span>LeScanCallback</span> callback<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="连接"><a href="#连接" class="header-anchor">#</a> 连接</h2> <h3 id="设备连接"><a href="#设备连接" class="header-anchor">#</a> 设备连接</h3> <p>通过扫描能够获得设备 BluetoothDevice，包含地址和名字</p> <p>通过设备连接并获取 BluetoothGatt，后面通过 BluetoothGatt 的实例来进行client的操作，如使用该实例去发现服务，获取读、写、通知等属性</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">BluetoothGatt</span> mBluetoothGatt<span class="token punctuation">;</span>
 
mBluetoothGatt <span class="token operator">=</span> device<span class="token punctuation">.</span><span class="token function">connectGatt</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> mGattCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>通过连接回调来监听连接的状态，包含三种状态，连接、断开、正在连接，根据状态可以发送广播，</p> <p>在接收广播的位置进行做相应的处理</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>rivate <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">BluetoothGattCallback</span> mGattCallback <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BluetoothGattCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onConnectionStateChange</span><span class="token punctuation">(</span><span class="token class-name">BluetoothGatt</span> gatt<span class="token punctuation">,</span> <span class="token keyword">int</span> status<span class="token punctuation">,</span>
                                            <span class="token keyword">int</span> newState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 
            <span class="token class-name">String</span> intentAction<span class="token punctuation">;</span>
            <span class="token comment">// GATT Server connected</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>newState <span class="token operator">==</span> <span class="token class-name">BluetoothProfile</span><span class="token punctuation">.</span>STATE_CONNECTED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;----------------------------&gt;已经连接&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                intentAction <span class="token operator">=</span> ACTION_GATT_CONNECTED<span class="token punctuation">;</span>
                mConnectionState <span class="token operator">=</span> STATE_CONNECTED<span class="token punctuation">;</span>
                <span class="token function">broadcastConnectionUpdate</span><span class="token punctuation">(</span>intentAction<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// GATT Server disconnected</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>newState <span class="token operator">==</span> <span class="token class-name">BluetoothProfile</span><span class="token punctuation">.</span>STATE_DISCONNECTED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;----------------------------&gt;连接断开&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                intentAction <span class="token operator">=</span> ACTION_GATT_DISCONNECTED<span class="token punctuation">;</span>
                mConnectionState <span class="token operator">=</span> STATE_DISCONNECTED<span class="token punctuation">;</span>
                <span class="token function">broadcastConnectionUpdate</span><span class="token punctuation">(</span>intentAction<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
            <span class="token punctuation">}</span>
            <span class="token comment">// GATT Server disconnected</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>newState <span class="token operator">==</span> <span class="token class-name">BluetoothProfile</span><span class="token punctuation">.</span>STATE_DISCONNECTING<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;----------------------------&gt;正在连接&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//                intentAction = ACTION_GATT_DISCONNECTING;</span>
<span class="token comment">//                mConnectionState = STATE_DISCONNECTING;</span>
<span class="token comment">//                broadcastConnectionUpdate(intentAction);</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><p>当操作完成后，需要关闭连接，必须调用 BluetoothGatt#close 方法释放连接资源</p> <h3 id="发现服务"><a href="#发现服务" class="header-anchor">#</a> 发现服务</h3> <p>由于有了 mBluetoothGatt，就可以去发现服务，再通过服务去获取可以操作的属性</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>mBluetoothGatt<span class="token punctuation">.</span><span class="token function">discoverServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>发现服务以及获取其他属性，如write和read，notify，Descriptor相关的属性，均是在 BluetoothGattCallback 中有回调，在回调中就可以通过发送广播，然后在其他位置做处理，</p> <p>如接收数据就会有回调，然后将数据传递出去，对数据解析等</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
       <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onServicesDiscovered</span><span class="token punctuation">(</span><span class="token class-name">BluetoothGatt</span> gatt<span class="token punctuation">,</span> <span class="token keyword">int</span> status<span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token comment">// GATT Services discovered</span>
           <span class="token comment">//发现新的服务</span>
           <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">==</span> <span class="token class-name">BluetoothGatt</span><span class="token punctuation">.</span>GATT_SUCCESS<span class="token punctuation">)</span> <span class="token punctuation">{</span>
               <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;----------------------------&gt;发现服务&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token function">broadcastConnectionUpdate</span><span class="token punctuation">(</span>ACTION_GATT_SERVICES_DISCOVERED<span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token punctuation">}</span> 
       <span class="token punctuation">}</span>
 
       <span class="token comment">//通过 Descriptor 写监听</span>
       <span class="token annotation punctuation">@Override</span>
       <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onDescriptorWrite</span><span class="token punctuation">(</span><span class="token class-name">BluetoothGatt</span> gatt<span class="token punctuation">,</span> <span class="token class-name">BluetoothGattDescriptor</span> descriptor<span class="token punctuation">,</span>
                                     <span class="token keyword">int</span> status<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 
       <span class="token punctuation">}</span>
 
       <span class="token comment">// 通过 Descriptor 读监听</span>
       <span class="token annotation punctuation">@Override</span>
       <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onDescriptorRead</span><span class="token punctuation">(</span><span class="token class-name">BluetoothGatt</span> gatt<span class="token punctuation">,</span> <span class="token class-name">BluetoothGattDescriptor</span> descriptor<span class="token punctuation">,</span>
                                    <span class="token keyword">int</span> status<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 
       <span class="token punctuation">}</span>
 
 
       <span class="token annotation punctuation">@Override</span>
       <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onCharacteristicWrite</span><span class="token punctuation">(</span><span class="token class-name">BluetoothGatt</span> gatt<span class="token punctuation">,</span> <span class="token class-name">BluetoothGattCharacteristic</span>
               characteristic<span class="token punctuation">,</span> <span class="token keyword">int</span> status<span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token comment">//write操作会调用此方法</span>
           <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">==</span> <span class="token class-name">BluetoothGatt</span><span class="token punctuation">.</span>GATT_SUCCESS<span class="token punctuation">)</span> <span class="token punctuation">{</span>
               <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;onCharacteristicWrite -------------------&gt;write success&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token class-name">Intent</span> intent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span>ACTION_GATT_CHARACTERISTIC_WRITE_SUCCESS<span class="token punctuation">)</span><span class="token punctuation">;</span>
               mContext<span class="token punctuation">.</span><span class="token function">sendBroadcast</span><span class="token punctuation">(</span>intent<span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
               <span class="token class-name">Intent</span> intent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span>ACTION_GATT_CHARACTERISTIC_ERROR<span class="token punctuation">)</span><span class="token punctuation">;</span>
               intent<span class="token punctuation">.</span><span class="token function">putExtra</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span>EXTRA_CHARACTERISTIC_ERROR_MESSAGE<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span> <span class="token operator">+</span> status<span class="token punctuation">)</span><span class="token punctuation">;</span>
               mContext<span class="token punctuation">.</span><span class="token function">sendBroadcast</span><span class="token punctuation">(</span>intent<span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token punctuation">}</span>
       <span class="token punctuation">}</span>
 
       <span class="token annotation punctuation">@Override</span>
       <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onCharacteristicRead</span><span class="token punctuation">(</span><span class="token class-name">BluetoothGatt</span> gatt<span class="token punctuation">,</span>
                                        <span class="token class-name">BluetoothGattCharacteristic</span> characteristic<span class="token punctuation">,</span> <span class="token keyword">int</span> status<span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token comment">// 接收数据</span>
       <span class="token punctuation">}</span>
 
       <span class="token annotation punctuation">@Override</span>
       <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onCharacteristicChanged</span><span class="token punctuation">(</span><span class="token class-name">BluetoothGatt</span> gatt<span class="token punctuation">,</span> <span class="token class-name">BluetoothGattCharacteristic</span> characteristic<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 
           <span class="token comment">//notify 会回调用此方法</span>
           <span class="token function">broadcastNotifyUpdate</span><span class="token punctuation">(</span>characteristic<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
 
       <span class="token annotation punctuation">@Override</span>
       <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onMtuChanged</span><span class="token punctuation">(</span><span class="token class-name">BluetoothGatt</span> gatt<span class="token punctuation">,</span> <span class="token keyword">int</span> mtu<span class="token punctuation">,</span> <span class="token keyword">int</span> status<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onMtuChanged</span><span class="token punctuation">(</span>gatt<span class="token punctuation">,</span> mtu<span class="token punctuation">,</span> status<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
       <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br></div></div><h3 id="数据传输"><a href="#数据传输" class="header-anchor">#</a> 数据传输</h3> <p>1、数据读取</p> <p>这里有两个方法：</p> <p>方法一： 一般数据读取的话，想到的是用 read 属性,所以需要获取特定通道的 BluetoothGattCharactristic。</p> <p>1）BluetoothGatt#getService 得到服务</p> <p>2）BluetoothGattService#getCharactristic 获取  BluetoothGattCharactristic，这里获取的 BluetoothGattCharactristic 是有指定 UUID  的，也就是说不同的 Charactristic的 UUID 是不同的，读和写的通道不同，根据不同的操作，然后通过UUID获取相应的通道</p> <p>3）BluetoothGattCharactristic#readCharacteristic 方法可以通知系统去读取特定的数据</p> <p>4）BluetoothGattCallback#onCharacteristicRead 方法。通过 BluetoothGattCharacteristic#getValue 可以读取到蓝牙设备的数据</p> <p>方法二：采用 notify 属性，客户端发送数据，服务端监听属性变化，然后根据 属性的 UUID 判断是否是 notify 的属性，如果是的话，说确实是由远程设备发过来的数据。</p> <p>1）BluetoothGatt#getService 得到服务</p> <p>2）BluetoothGattService#getCharactristic 获取 BluetoothGattCharactristic，这里的这个属性是 notify 属性</p> <p>3）获得属性后需要进行判断设备是否支持notify操作，然后再设备打开notify通知</p> <ol start="4"><li>设置属性时，也要通知远程设备端也要开启 notify 属性</li></ol> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">void</span> <span class="token function">prepareBroadcastDataNotify</span><span class="token punctuation">(</span>
            <span class="token class-name">BluetoothGattCharacteristic</span> characteristic<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 
        <span class="token keyword">final</span> <span class="token keyword">int</span> charaProp <span class="token operator">=</span> characteristic<span class="token punctuation">.</span><span class="token function">getProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
        <span class="token class-name">Toast</span><span class="token punctuation">.</span><span class="token function">makeText</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token string">&quot; &quot;</span> <span class="token operator">+</span> charaProp<span class="token punctuation">,</span> <span class="token class-name">Toast</span><span class="token punctuation">.</span>LENGTH_SHORT<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>charaProp <span class="token operator">|</span> <span class="token class-name">BluetoothGattCharacteristic</span><span class="token punctuation">.</span>PROPERTY_NOTIFY<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">BluetoothLeService</span><span class="token punctuation">.</span><span class="token function">setCharacteristicNotification</span><span class="token punctuation">(</span>characteristic<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
 
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">setCharacteristicNotification</span><span class="token punctuation">(</span><span class="token class-name">BluetoothGattCharacteristic</span> characteristic<span class="token punctuation">,</span> <span class="token keyword">boolean</span> enabled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mBluetoothAdapter <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> mBluetoothGatt <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//通知远程端开启 notify </span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>characteristic<span class="token punctuation">.</span><span class="token function">getDescriptor</span><span class="token punctuation">(</span>UUID<span class="token punctuation">.</span><span class="token function">fromString</span><span class="token punctuation">(</span><span class="token class-name">GattAttributes</span><span class="token punctuation">.</span>CLIENT_CHARACTERISTIC_CONFIG<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>enabled <span class="token operator">==</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">BluetoothGattDescriptor</span> descriptor <span class="token operator">=</span> characteristic
                        <span class="token punctuation">.</span><span class="token function">getDescriptor</span><span class="token punctuation">(</span>UUID<span class="token punctuation">.</span><span class="token function">fromString</span><span class="token punctuation">(</span><span class="token class-name">GattAttributes</span><span class="token punctuation">.</span>CLIENT_CHARACTERISTIC_CONFIG<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                descriptor<span class="token punctuation">.</span><span class="token function">setValue</span><span class="token punctuation">(</span><span class="token class-name">BluetoothGattDescriptor</span><span class="token punctuation">.</span>ENABLE_NOTIFICATION_VALUE<span class="token punctuation">)</span><span class="token punctuation">;</span>
                mBluetoothGatt<span class="token punctuation">.</span><span class="token function">writeDescriptor</span><span class="token punctuation">(</span>descriptor<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token class-name">BluetoothGattDescriptor</span> descriptor <span class="token operator">=</span> characteristic
                        <span class="token punctuation">.</span><span class="token function">getDescriptor</span><span class="token punctuation">(</span>UUID<span class="token punctuation">.</span><span class="token function">fromString</span><span class="token punctuation">(</span><span class="token class-name">GattAttributes</span><span class="token punctuation">.</span>CLIENT_CHARACTERISTIC_CONFIG<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                descriptor<span class="token punctuation">.</span><span class="token function">setValue</span><span class="token punctuation">(</span><span class="token class-name">BluetoothGattDescriptor</span><span class="token punctuation">.</span>DISABLE_NOTIFICATION_VALUE<span class="token punctuation">)</span><span class="token punctuation">;</span>
                mBluetoothGatt<span class="token punctuation">.</span><span class="token function">writeDescriptor</span><span class="token punctuation">(</span>descriptor<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        mBluetoothGatt<span class="token punctuation">.</span><span class="token function">setCharacteristicNotification</span><span class="token punctuation">(</span>characteristic<span class="token punctuation">,</span> enabled<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>数据写入</p> <p>对于 BLE 方式的数据传输来说，数据的大小是有限制的，一次性最多可以传输512个字节，这也是BLE小数据量传输的特点，另外，对于每次传输，也有限制，每个数据包大小不超过20个字节，超过20个字节的话，需要分包处理。写的步骤和读取类似。</p> <p>1）BluetoothGatt#getService 得到服务</p> <p>2）BluetoothGattService#getCharactristic 获取 BluetoothGattCharactristic，这里的这个属性是 write 属性</p> <p>3）写入字节数据</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">writeCharacteristicGattDb</span><span class="token punctuation">(</span>
            <span class="token class-name">BluetoothGattCharacteristic</span> characteristic<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> byteArray<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mBluetoothAdapter <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> mBluetoothGatt <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> valueByte <span class="token operator">=</span> byteArray<span class="token punctuation">;</span>
            characteristic<span class="token punctuation">.</span><span class="token function">setValue</span><span class="token punctuation">(</span>valueByte<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mBluetoothGatt<span class="token punctuation">.</span><span class="token function">writeCharacteristic</span><span class="token punctuation">(</span>characteristic<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>4)对于手机端，写入数据后，远程端会接受，同时回调中也会能够接收，也可以在回调中做一下数据判断，看是否是自己发出的数据</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
       <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onCharacteristicWrite</span><span class="token punctuation">(</span><span class="token class-name">BluetoothGatt</span> gatt<span class="token punctuation">,</span> <span class="token class-name">BluetoothGattCharacteristic</span>
               characteristic<span class="token punctuation">,</span> <span class="token keyword">int</span> status<span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token comment">//write操作会调用此方法</span>
           <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">==</span> <span class="token class-name">BluetoothGatt</span><span class="token punctuation">.</span>GATT_SUCCESS<span class="token punctuation">)</span> <span class="token punctuation">{</span>
               <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;onCharacteristicWrite -------------------&gt;write success&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token class-name">Intent</span> intent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span>ACTION_GATT_CHARACTERISTIC_WRITE_SUCCESS<span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token comment">// 这里通过属性能够读取你发送的数据，可以对此数据进行判断</span>
               characteristic<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
               mContext<span class="token punctuation">.</span><span class="token function">sendBroadcast</span><span class="token punctuation">(</span>intent<span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
               <span class="token class-name">Intent</span> intent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span>ACTION_GATT_CHARACTERISTIC_ERROR<span class="token punctuation">)</span><span class="token punctuation">;</span>
               intent<span class="token punctuation">.</span><span class="token function">putExtra</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span>EXTRA_CHARACTERISTIC_ERROR_MESSAGE<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span> <span class="token operator">+</span> status<span class="token punctuation">)</span><span class="token punctuation">;</span>
               mContext<span class="token punctuation">.</span><span class="token function">sendBroadcast</span><span class="token punctuation">(</span>intent<span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token punctuation">}</span>
       <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h2 id="其他"><a href="#其他" class="header-anchor">#</a> 其他</h2> <p>一般在通讯过程中，需要有连接的心跳包，来检测是否仍处于连接状态，可以通过设置定时器，主机端定时 write 数据，客户端定时 notify 数据</p> <h2 id="断开连接"><a href="#断开连接" class="header-anchor">#</a> 断开连接</h2> <p>操作完成，需要断开蓝牙并释放资源,通过 BluetoothGatt#disconnect  断开连接，然后回调中会收到断开的监听，可以根据状态释放资源。BluetoothGattCallback#onConnectionStateChange回调中通过这个方法的 newState 参数可以判断是连接成功还是断开成功的回调，断开成功的话，然后调用 BluetoothGatt#close 方法释放资源</p> <h2 id="分包与组包"><a href="#分包与组包" class="header-anchor">#</a> 分包与组包</h2> <h3 id="分包"><a href="#分包" class="header-anchor">#</a> 分包：</h3> <p>分包说白了就是一套通讯协议</p> <p>一包数据的格式 -&gt; 协议头 + 总包号 + 当前包号 + 命令号 + 内容 + 协议尾</p> <h3 id="组包"><a href="#组包" class="header-anchor">#</a> 组包：</h3> <p>BLE单次写的数据量大小是有限制的，通常是20字节，可以尝试通过requestMTU增大，但不保证能成功。分包写是一种解决方案，需要定义分包协议，假设每个包大小20字节，分两种包，数据包和非数据包。对于数据包，头两个字节表示包的序号，剩下的都填充数据。对于非数据包，主要是发送一些控制信息。</p> <p>总体流程如下：</p> <p>1、发端发送控制包，告诉对方要发送的总的包数</p> <p>2、收端回一个ACK包，表示准备好了，对方可以发送了</p> <p>3、发端开始批量发送数据，为了速度，不需要对端回复</p> <p>4、收端收到最后一个包或超时后，开始检查还缺哪些包，然后回复ACK，带上丢的包序号</p> <p>5、发端重发丢的包</p> <p>6、收端全部收到，回复ACK，CRC校验，包数据拼接好了传到上层</p> <p>这里面核心是状态机，另外要注意对于BLE来说，主端和从端都可以收发数据，但是是非对称的。对主端来说，发是write  characteristic，收是onCharacteristicChanged，对从端来说，发是sendNotify，收是onCharacteristicWrite。尽管如此，但是协议部分是相同的，所以我们要抽象成两层，底层是收发的物理层，上层是分包的协议层，再上层就是业务层。</p></div></div> <div class="page-slot page-slot-bottom"><!-- 横向自适应 -->
      <ins class="adsbygoogle"
          style="display:block"
          data-ad-client="ca-pub-7828333725993554"
          data-ad-slot="6620245489"
          data-ad-format="auto"
          data-full-width-responsive="true"></ins>
      <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
      </script></div> <div class="page-edit"><div class="edit-link"><a href="https://github.com/wyba/blog/edit/master/docs/01.Android/30.蓝牙通信.md" target="_blank" rel="noopener noreferrer">编辑</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="tags"><a href="/blog/tags/?tag=BLE" title="标签">#BLE</a></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2022/05/06, 17:26:02</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/blog/pages/8aff38/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">动画简介</div></a> <!----></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/blog/pages/8aff38/" class="prev">动画简介</a></span> <!----></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/blog/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/blog/pages/8aff38/"><div>
            动画简介
            <!----></div></a> <span class="date">04-29</span></dt></dl><dl><dd>02</dd> <dt><a href="/blog/pages/99060e/"><div>
            View工作流程
            <!----></div></a> <span class="date">04-29</span></dt></dl><dl><dd>03</dd> <dt><a href="/blog/pages/37f9d7/"><div>
            MeasureSpec原理
            <!----></div></a> <span class="date">04-29</span></dt></dl> <dl><dd></dd> <dt><a href="/blog/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="mailto:1070096495@qq.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/wyba" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://music.163.com/#/playlist?id=755597173" title="听音乐" target="_blank" class="iconfont icon-erji"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2021-2022
    <span>wyb | <a href="https://github.com/wyba/blob/master/LICENSE" target="_blank">MIT License</a></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <div class="custom-html-window custom-html-window-rb" style="display:;"><div class="custom-wrapper"><span class="close-but">×</span> <div><!-- 固定160*160px -->
      <ins class="adsbygoogle"
          style="display:inline-block;max-width:160px;max-height:160px"
          data-ad-client="ca-pub-7828333725993554"
          data-ad-slot="8377369658"></ins>
      <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
      </script>
      </div></div></div></div><div class="global-ui"><div></div></div></div>
    <script src="/blog/assets/js/app.7a0bcda5.js" defer></script><script src="/blog/assets/js/2.a5a0f980.js" defer></script><script src="/blog/assets/js/37.9036f6e9.js" defer></script>
  </body>
</html>
